---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Nueva contraseña - Gestor de Avisos">
  <div id="reset-container"></div>
</Layout>

<script>
  import { apiClient } from '../lib/apiClient';

  const container = document.getElementById('reset-container');

  // Obtener token de la URL
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');

  if (!token) {
    if (container) {
      container.innerHTML = `
        <div class="min-h-screen flex items-center justify-center p-6">
          <div class="w-full max-w-md rounded-2xl border border-rose-200 bg-rose-50 p-8 text-center shadow-sm ring-1 ring-black/5">
            <h2 class="text-xl font-semibold text-gray-900">Enlace inválido</h2>
            <p class="mt-2 text-sm text-gray-600">El enlace de recuperación no es válido</p>
            <a href="/forgot-password" class="mt-6 inline-flex w-full items-center justify-center rounded-xl bg-blue-600 px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700">
              Solicitar nuevo enlace
            </a>
          </div>
        </div>
      `;
    }
  } else {
    if (container) {
      container.innerHTML = `
        <div class="min-h-screen relative flex items-center justify-center p-4">
          <!-- Fondo suave -->
          <div class="pointer-events-none absolute inset-0 bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50"></div>
          <div class="pointer-events-none absolute inset-0 opacity-40 bg-[radial-gradient(circle_at_20%_20%,rgba(37,99,235,0.18),transparent_45%),radial-gradient(circle_at_80%_20%,rgba(99,102,241,0.14),transparent_45%),radial-gradient(circle_at_50%_90%,rgba(168,85,247,0.12),transparent_55%)]"></div>

          <div class="relative w-full max-w-md">
            <!-- Card -->
            <div class="overflow-hidden rounded-2xl bg-white/85 backdrop-blur border border-white/60 shadow-[0_20px_60px_-20px_rgba(0,0,0,0.35)] ring-1 ring-black/5">
              <!-- Header -->
              <div class="p-6 border-b border-gray-100 bg-white/70 backdrop-blur">
                <p class="text-xs font-semibold tracking-wide text-gray-500">Nadir</p>
                <h1 class="mt-1 text-xl font-semibold text-gray-900">Nueva contraseña</h1>
                <p class="mt-1 text-sm text-gray-600">
                  Introduce tu nueva contraseña (mínimo 6 caracteres).
                </p>
              </div>

              <!-- Form -->
              <form id="reset-form" class="p-6 space-y-4">
                <!-- Message -->
                <div id="message-container"></div>

                <!-- Password -->
                <div>
                  <label class="mb-2 block text-sm font-semibold text-gray-700">Nueva contraseña</label>
                  <input
                    id="password-input"
                    type="password"
                    required
                    minlength="6"
                    placeholder="mín. 6 caracteres"
                    class="w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm text-gray-900 shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10"
                  />
                </div>

                <!-- Confirm Password -->
                <div>
                  <label class="mb-2 block text-sm font-semibold text-gray-700">Confirmar contraseña</label>
                  <input
                    id="confirm-password-input"
                    type="password"
                    required
                    minlength="6"
                    placeholder="repite la contraseña"
                    class="w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm text-gray-900 shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10"
                  />
                </div>

                <!-- Submit -->
                <button
                  type="submit"
                  id="submit-btn"
                  class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-blue-600 px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:bg-blue-400"
                >
                  Cambiar contraseña
                </button>
              </form>
            </div>

            <!-- Footer -->
            <div class="mt-4 text-center text-xs text-gray-500">
              © ${new Date().getFullYear()} Carlosgorostiaga.dev · Gestor de avisos
            </div>
          </div>
        </div>
      `;

      const form = document.getElementById('reset-form') as HTMLFormElement;
      const passwordInput = document.getElementById('password-input') as HTMLInputElement;
      const confirmPasswordInput = document.getElementById(
        'confirm-password-input'
      ) as HTMLInputElement;
      const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
      const messageContainer = document.getElementById('message-container');

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (password.length < 6) {
          showMessage('error', 'La contraseña debe tener al menos 6 caracteres');
          return;
        }

        if (password !== confirmPassword) {
          showMessage('error', 'Las contraseñas no coinciden');
          return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = `
          <span class="inline-flex h-4 w-4 animate-spin rounded-full border-2 border-white/70 border-t-transparent"></span>
          Cambiando...
        `;

        try {
          await apiClient.resetPassword(token, password);
          showMessage('success', 'Contraseña actualizada correctamente. Redirigiendo...');

          setTimeout(() => {
            window.location.href = '/';
          }, 2000);
        } catch (error: any) {
          showMessage('error', error.message || 'Error al cambiar la contraseña');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Cambiar contraseña';
        }
      });

      function showMessage(type: 'success' | 'error', text: string) {
        if (!messageContainer) return;

        const bgColor =
          type === 'success'
            ? 'bg-emerald-50 border-emerald-200 text-emerald-800'
            : 'bg-rose-50 border-rose-200 text-rose-800';

        messageContainer.innerHTML = `
          <div class="rounded-2xl border ${bgColor} px-4 py-3 text-sm font-semibold">
            ${text}
          </div>
        `;
      }
    }
  }
</script>
