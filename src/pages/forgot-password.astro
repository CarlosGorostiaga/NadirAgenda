---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Recuperar contraseña - Gestor de Avisos">
  <div id="forgot-container"></div>
</Layout>

<script>
  import { apiClient } from '../lib/apiClient';

  const container = document.getElementById('forgot-container');

  if (container) {
    container.innerHTML = `
      <div class="min-h-screen relative flex items-center justify-center p-4">
        <!-- Fondo suave -->
        <div class="pointer-events-none absolute inset-0 bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50"></div>
        <div class="pointer-events-none absolute inset-0 opacity-40 bg-[radial-gradient(circle_at_20%_20%,rgba(37,99,235,0.18),transparent_45%),radial-gradient(circle_at_80%_20%,rgba(99,102,241,0.14),transparent_45%),radial-gradient(circle_at_50%_90%,rgba(168,85,247,0.12),transparent_55%)]"></div>

        <div class="relative w-full max-w-md">
          <!-- Card -->
          <div class="overflow-hidden rounded-2xl bg-white/85 backdrop-blur border border-white/60 shadow-[0_20px_60px_-20px_rgba(0,0,0,0.35)] ring-1 ring-black/5">
            <!-- Header -->
            <div class="p-6 border-b border-gray-100 bg-white/70 backdrop-blur">
              <p class="text-xs font-semibold tracking-wide text-gray-500">Nadir</p>
              <h1 class="mt-1 text-xl font-semibold text-gray-900">Recuperar contraseña</h1>
              <p class="mt-1 text-sm text-gray-600">
                Introduce tu email y te enviaremos un enlace para crear una nueva contraseña.
              </p>
            </div>

            <!-- Form -->
            <form id="forgot-form" class="p-6 space-y-4">
              <!-- Message -->
              <div id="message-container"></div>

              <!-- Email -->
              <div>
                <label class="mb-2 block text-sm font-semibold text-gray-700">Email</label>
                <input
                  id="email-input"
                  type="email"
                  required
                  placeholder="tuemail@correo.com"
                  class="w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm text-gray-900 shadow-sm outline-none transition placeholder:text-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10"
                />
              </div>

              <!-- Submit -->
              <button
                type="submit"
                id="submit-btn"
                class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-blue-600 px-4 py-3 text-sm font-semibold text-white shadow-sm transition hover:bg-blue-700 disabled:cursor-not-allowed disabled:bg-blue-400"
              >
                Enviar enlace de recuperación
              </button>

              <!-- Back link -->
              <div class="text-center">
                <a href="/" class="text-sm text-blue-600 hover:text-blue-700 font-semibold">
                  ← Volver al inicio
                </a>
              </div>
            </form>
          </div>

          <!-- Footer -->
          <div class="mt-4 text-center text-xs text-gray-500">
            © ${new Date().getFullYear()} Carlosgorostiaga.dev · Gestor de avisos
          </div>
        </div>
      </div>
    `;

    const form = document.getElementById('forgot-form') as HTMLFormElement;
    const emailInput = document.getElementById('email-input') as HTMLInputElement;
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const messageContainer = document.getElementById('message-container');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = emailInput.value.trim();

      if (!email || !email.includes('@')) {
        showMessage('error', 'Email inválido');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.innerHTML = `
        <span class="inline-flex h-4 w-4 animate-spin rounded-full border-2 border-white/70 border-t-transparent"></span>
        Enviando...
      `;

      try {
        await apiClient.forgotPassword(email);
        showMessage(
          'success',
          'Si el email existe, recibirás un enlace para restablecer tu contraseña. Revisa tu bandeja de entrada.'
        );
        emailInput.value = '';
      } catch (error: any) {
        showMessage('error', error.message || 'Error al enviar el email');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Enviar enlace de recuperación';
      }
    });

    function showMessage(type: 'success' | 'error', text: string) {
      if (!messageContainer) return;

      const bgColor =
        type === 'success'
          ? 'bg-emerald-50 border-emerald-200 text-emerald-800'
          : 'bg-rose-50 border-rose-200 text-rose-800';

      messageContainer.innerHTML = `
        <div class="rounded-2xl border ${bgColor} px-4 py-3 text-sm font-semibold">
          ${text}
        </div>
      `;

      setTimeout(() => {
        messageContainer.innerHTML = '';
      }, 8000);
    }
  }
</script>
